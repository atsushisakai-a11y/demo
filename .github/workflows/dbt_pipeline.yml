name: Run dbt Pipeline

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Optional: run a single dbt model"
        required: false
        type: string

jobs:
  run-dbt-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    # -------------------------
    # 1. CHECKOUT
    # -------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # -------------------------
    # 2. PYTHON + DBT
    # -------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dbt-bigquery
      run: |
        pip install --upgrade pip
        pip install dbt-bigquery

    # -------------------------
    # 3. GCP SERVICE ACCOUNT / PROFILE
    # -------------------------
    - name: Decode GCP service account key
      run: echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > key.json

    - name: Create profiles.yml
      run: |
        mkdir -p ~/.dbt
        cat > ~/.dbt/profiles.yml << EOF
        demo:
          target: prod
          outputs:
            prod:
              type: bigquery
              method: service-account
              project: grand-water-473707-r8
              keyfile: key.json
              schema: ""
              threads: 4
              location: EU
        EOF

    # -------------------------
    # 4. VERIFY ENVIRONMENT
    # -------------------------
    - name: Show folder tree
      run: |
        echo "--- REPO TREE ---"
        ls -R .

    - name: dbt Debug
      run: dbt debug

    # -------------------------
    # 5. RUN FULL DBT PIPELINE
    # Automatically detects:
    #   staging folder → schema=staging
    #   dwh folder     → schema=dwh
    #   datamart folder→ schema=datamart
    # -------------------------
    - name: Run full dbt pipeline
      if: ${{ github.event.inputs.model_name == '' }}
      run: |
        echo "Running full dbt build (auto: staging → dwh → datamart)"
        dbt build

    # OR run single model
    - name: Run single dbt model
      if: ${{ github.event.inputs.model_name != '' }}
      run: |
        MODEL="${{ github.event.inputs.model_name }}"
        echo "Running single dbt model: $MODEL"
        dbt run --select "$MODEL"

    # -------------------------
    # 6. GENERATE DBT DOCS
    # -------------------------
    - name: Generate docs
      run: dbt docs generate

    - name: Prepare docs for GitHub Pages
      run: |
        mkdir -p public
        cp -r target/* public/

    # -------------------------
    # 7. UPLOAD & DEPLOY DOCS
    # -------------------------
    - name: Upload docs artifact
      uses: actions/upload-pages-artifact@v3
      with:
        name: github-pages
        path: public

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
