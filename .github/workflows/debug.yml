name: DBT Debug

on:
  workflow_dispatch:

jobs:
  debug-dbt:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 1. CHECK OUT THE REPOSITORY
      # ---------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------------------
      # 2. SET UP PYTHON
      # ---------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # ---------------------------------------
      # 3. INSTALL DBT-BIGQUERY
      # ---------------------------------------
      - name: Install dbt-bigquery
        run: |
          pip install --upgrade pip
          pip install dbt-bigquery

      # ---------------------------------------
      # 4. DECODE GCP SERVICE ACCOUNT
      # ---------------------------------------
      - name: Decode GCP SA Key
        run: |
          echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > key.json

      # ---------------------------------------
      # 5. CREATE ~/.dbt/profiles.yml
      # ---------------------------------------
      - name: Create dbt profiles.yml
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          demo:
            target: prod
            outputs:
              prod:
                type: bigquery
                method: service-account
                project: grand-water-473707-r8
                keyfile: key.json
                dataset: staging
                threads: 4
                location: EU
          EOF


      - name: Find dbt_project.yml
        run: |
          echo "Searching for dbt_project.yml ..."
          find . -name dbt_project.yml -print

      # ---------------------------------------
      # 6. INSTALL DBT PACKAGES
      # ---------------------------------------
      - name: Install dbt packages (dbt deps)
        run: dbt deps --project-dir ./dbt --profiles-dir ~/.dbt

      # ---------------------------------------
      # 7. SHOW PROJECT STRUCTURE
      # ---------------------------------------
      - name: Show repo structure
        run: |
          echo "=== WORKING DIRECTORY ==="
          pwd
          echo "=== REPO TREE ==="
          ls -R .

      # ---------------------------------------
      # 8. DBT DEBUG (connectivity + environment)
      # ---------------------------------------
      - name: DBT Debug
        run: dbt debug --project-dir ./dbt --profiles-dir ~/.dbt

      # ---------------------------------------
      # 9. DBT LS (SHOW ALL MODELS)
      # ---------------------------------------
      - name: DBT LS (all models)
        run: dbt ls --project-dir ./dbt --profiles-dir ~/.dbt

      # ---------------------------------------
      # 10. DBT LS (specific model)
      # ---------------------------------------
      - name: DBT LS (dim_google_places_dbt)
        run: dbt ls --select dim_google_places_dbt --output path --project-dir ./dbt --profiles-dir ~/.dbt

      # ---------------------------------------
      # 11. SHOW PARSED PROJECT INFO
      # ---------------------------------------
      - name: Show parsed dbt project info
        run: dbt debug --project-dir ./dbt --profiles-dir ~/.dbt
