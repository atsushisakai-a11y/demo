name: GE Classic Validation

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run_ge_checkpoint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev

      #- name: Install dependencies
      #  run: |
      #    python -m pip install --upgrade pip
          
      #    # 1. FIX: Force NumPy to stay on version 1.x
      #    pip install "numpy<2.0"
          
      #    # 2. Then install your other tools (keep your pinned GX version if using legacy config)
      #    pip install "great_expectations<1.0.0"
      #    pip install sqlalchemy-bigquery          

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # Install specific versions to prevent conflicts
          # 1. numpy<2.0 fixes the binary incompatibility
          # 2. great_expectations<1.0.0 brings back "SqlAlchemyDatasource"
          pip install "numpy<2.0" "great_expectations<1.0.0" sqlalchemy-bigquery          

      - name: Verify GE Classic installation
        run: |
          python - <<EOF
          import great_expectations as ge
          import pkgutil
          
          print("GE version:", ge.__version__)
          print("SqlAlchemyDatasource exists?", pkgutil.find_loader("great_expectations.datasource.sqlalchemy_datasource"))
          EOF

      - name: Set Google Credentials
        run: |
          echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > key.json
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Export GOOGLE_APPLICATION_CREDENTIALS
        run: echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/key.json" >> $GITHUB_ENV

      - name: Run GE checkpoint
        run: |
          great_expectations checkpoint run dim_parkbee_locations
