name: GE Classic Validation

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run_ge_checkpoint:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev

      - name: Install Python dependencies (GE Classic)
        run: |
          python -m pip install --upgrade pip
          pip install "numpy<2.0" "great_expectations<1.0.0" sqlalchemy-bigquery

      - name: Verify GE Classic installation
        run: |
          python - << 'EOF'
          import great_expectations as ge
          import pkgutil
          print("GE version:", ge.__version__)
          print("SqlAlchemyDatasource exists?", pkgutil.find_loader("great_expectations.datasource.sqlalchemy_datasource"))
          EOF

      - name: Set Google Credentials
        run: |
          echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > key.json
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Export GOOGLE_APPLICATION_CREDENTIALS
        run: |
          echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/key.json" >> $GITHUB_ENV

      - name: Debug GE root + datasources
        run: |
          echo "=== GE Version ==="
          great_expectations --version

          echo "=== Loaded GE Config ==="
          python - << 'EOF'
          from great_expectations.data_context import FileDataContext
          ctx = FileDataContext()
          print("GE root directory:", ctx.root_directory)
          print("Datasources:", list(ctx.datasources.keys()))
          for name, ds in ctx.datasources.items():
              print(f"Datasource: {name}, connectors: {list(ds.data_connectors.keys())}")
          EOF
          
      - name: Debug checkpoint presence
        run: |
          echo "Listing checkpoints folder"
          ls -R great_expectations/checkpoints || echo "No checkpoints folder"

      - name: DEBUG 1 — Print GE Root Directory
        run: |
          python - <<EOF
          from great_expectations.data_context import FileDataContext
          ctx = FileDataContext()
          print("GE ROOT DIR =", ctx.root_directory)
          print("Datasources:", ctx.datasources.keys())
          print("Checkpoints dir exists?", ctx.root_directory + "/checkpoints")
          EOF

      - name: DEBUG 2 — List checkpoints folder
        run: ls -R great_expectations/checkpoints || echo "NO CHECKPOINT FOLDER FOUND"

      - name: DEBUG 3 — GE list checkpoints
        run: great_expectations checkpoint list

      - name: DEBUG 4 — GE checkpoint list
        run: |
          echo "=== GE CHECKPOINT LIST ==="
          great_expectations checkpoint list || echo "Failed to list checkpoints"

      - name: DEBUG 5 — GE checkpoint new (non-interactive)"
        run: |
          echo "=== GE CHECKPOINT NEW TEST ==="
          great_expectations checkpoint new dim_parkbee_locations --no-interactive || echo "Checkpoint creation failed"

      - name: DEBUG 6 — Inspect checkpoints folder after GE new"
        run: |
          echo "=== LIST CHECKPOINTS FOLDER AFTER NEW ==="
          ls -R great_expectations/checkpoints || echo "No checkpoints folder found"

      - name: Run GE checkpoint
        run: |
          great_expectations checkpoint run dim_parkbee_locations
