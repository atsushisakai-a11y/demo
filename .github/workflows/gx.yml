name: GE Classic Validation

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run_ge_checkpoint:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1. CHECKOUT
      # --------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4


      # --------------------------------------------------------
      # 2. PYTHON 3.11 + build tools
      # --------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev


      # --------------------------------------------------------
      # 3. INSTALL DEPENDENCIES (Classic GE + BigQuery)
      # --------------------------------------------------------
      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip

          # Required to avoid binary conflicts with GE Classic
          pip install "numpy<2.0"

          # Classic GE with SqlAlchemyDatasource
          pip install "great_expectations<1.0.0"

          # BigQuery support
          pip install sqlalchemy-bigquery


      # --------------------------------------------------------
      # 4. FORCE GE TO USE THE CORRECT PROJECT ROOT
      # --------------------------------------------------------
      - name: Force GE to use correct GE project directory
        run: |
          echo "GE_HOME=${{ github.workspace }}/great_expectations" >> $GITHUB_ENV
          echo "GE_ROOT_DIR=${{ github.workspace }}/great_expectations" >> $GITHUB_ENV
          echo "GE_DATA_CONTEXT_ROOT_DIR=${{ github.workspace }}/great_expectations" >> $GITHUB_ENV

      # --------------------------------------------------------
      # 5. INSTALL GOOGLE CREDENTIALS
      # --------------------------------------------------------
      - name: Install GCP service account credentials
        run: |
          echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > key.json

      - name: Export GOOGLE_APPLICATION_CREDENTIALS
        run: echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/key.json" >> $GITHUB_ENV


      # --------------------------------------------------------
      # 6. DEBUG â€” Verify GE sees your datasources + checkpoints
      # --------------------------------------------------------
      - name: Debug Verify GE Loads Correct Context
        run: |
          python - <<EOF
          from great_expectations.data_context import FileDataContext

          ctx = FileDataContext()
          print("=== GE ROOT DIRECTORY ===")
          print(ctx.root_directory)

          print("=== DATASOURCES ===")
          print(ctx.datasources.keys())

          print("=== CHECKPOINTS ===")
          print(ctx.list_checkpoints())
          EOF

      - name: Debug File structure
        run: |
          echo "=== Checkpoint folder ==="
          ls -R great_expectations/checkpoints || echo "not found"

          echo "=== Datasources folder ==="
          ls -R great_expectations/datasources || echo "not found"


      # --------------------------------------------------------
      # 7. RUN CHECKPOINT
      # --------------------------------------------------------
      - name: Run GE checkpoint
        run: |
          great_expectations checkpoint run dim_parkbee_locations
