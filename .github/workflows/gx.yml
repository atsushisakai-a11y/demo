name: GE Classic Validation

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run_ge_checkpoint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev

      - name: Install GE Classic + BigQuery dependencies
        run: |
          pip install --upgrade pip setuptools wheel

          # Versions compatible with GE Classic
          pip install numpy==1.23.5
          pip install pandas==1.5.3
          pip install sqlalchemy==1.4.52
          pip install sqlalchemy-bigquery==1.16.0
          pip install pybigquery

          # Correct Great Expectations
          pip install great_expectations==0.16.16

      - name: Verify GE Classic installation
        run: |
          python - <<EOF
          import great_expectations as ge
          import pkgutil
          
          print("GE version:", ge.__version__)
          print("SqlAlchemyDatasource exists?", pkgutil.find_loader("great_expectations.datasource.sqlalchemy_datasource"))
          EOF

      - name: Set Google Credentials
        run: |
          echo "$GOOGLE_CREDS" > key.json
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Export GOOGLE_APPLICATION_CREDENTIALS
        run: echo "GOOGLE_APPLICATION_CREDENTIALS=${{ github.workspace }}/key.json" >> $GITHUB_ENV

      - name: Run GE checkpoint
        run: |
          great_expectations checkpoint run dim_parkbee_locations
