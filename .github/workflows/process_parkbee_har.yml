name: Process ParkBee HAR to BigQuery

on:
  workflow_dispatch:
    inputs:
      har_filename:
        description: "HAR file name in GCS (e.g., parkbee_2025-01-18.har)"
        required: true
        type: string

jobs:
  har-to-bigquery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Decode GCP service account key
        run: echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > $HOME/key.json

      - name: Authenticate with gcloud
        run: |
          gcloud auth activate-service-account --key-file=$HOME/key.json
          gcloud config set project grand-water-473707-r8

      - name: Download HAR file from GCS
        run: |
          echo "Downloading HAR file..."
          gsutil cp gs://parkbee-har-data/${{ github.event.inputs.har_filename }} .
          echo "Downloaded: ${{ github.event.inputs.har_filename }}"

      - name: Run extraction script
        run: |
          echo "Extracting garages from HAR..."
          python scripts/extract_parkbee.py ${{ github.event.inputs.har_filename }}

      - name: Upload JSON to GCS
        run: |
          JSON_FILE=$(ls parkbee_garages_*.json)
          echo "Uploading JSON file $JSON_FILE to GCS..."
          gsutil cp $JSON_FILE gs://parkbee-raw-data/$JSON_FILE
          echo "Uploaded JSON to GCS: $JSON_FILE"

      - name: Load JSON into BigQuery (temporary table)
        run: |
          JSON_FILE=$(ls parkbee_garages_*.json)
          echo "Removing old temp table if exists..."
          bq rm -f -t raw.new_parkbee_garages_tmp || true
          echo "Loading $JSON_FILE into raw.new_parkbee_garages_tmp..."
          bq load \
            --source_format=NEWLINE_DELIMITED_JSON \
            --autodetect \
            raw.new_parkbee_garages_tmp \
            gs://parkbee-raw-data/$JSON_FILE

      - name: Normalize temporary table schema
        run: |
          echo "Normalizing temp table schema to match raw table..."
          bq query --use_legacy_sql=false "
          CREATE OR REPLACE TABLE \`raw.new_parkbee_garages_tmp\` AS
          SELECT
            id,
            name,
            latitude,
            longitude,
            STRUCT(
              address.city AS city,
              address.country AS country,
              CAST(NULL AS STRING) AS street,
              CAST(NULL AS STRING) AS number,
              CAST(NULL AS STRING) AS postCode
            ) AS address,
            STRUCT(
              STRUCT(
                pricingAndAvailability.pricing.cost AS cost,
                pricingAndAvailability.pricing.currency AS currency
              ) AS pricing,
              STRUCT(
                pricingAndAvailability.availability.availableSpaces AS availableSpaces,
                pricingAndAvailability.availability.totalSpaces AS totalSpaces
              ) AS availability
            ) AS pricingAndAvailability,
            scrape_datetime
          FROM \`raw.new_parkbee_garages_tmp\`;
          "
          echo "Temp table normalized successfully."


      - name: Merge data into raw.raw_parkbee_garages
        run: |
          echo "Merging new data into raw.raw_parkbee_garages..."
          bq query --use_legacy_sql=false "
          MERGE INTO \`raw.raw_parkbee_garages\` AS target
          USING (
            SELECT
              id,
              name,
              latitude,
              longitude,
              address,
              pricingAndAvailability,
              scrape_datetime
            FROM \`raw.new_parkbee_garages_tmp\`
          ) AS source
          ON target.id = source.id AND target.scrape_datetime = source.scrape_datetime
          WHEN NOT MATCHED THEN
            INSERT (
              id, name, latitude, longitude, address, pricingAndAvailability, scrape_datetime
            )
            VALUES (
              source.id, source.name, source.latitude, source.longitude, source.address,
              source.pricingAndAvailability, source.scrape_datetime
            );
          "
          echo "Merge complete!"

      - name: Clean up temporary table
        if: always()
        run: |
          echo "Removing temporary table..."
          bq rm -f -t raw.new_parkbee_garages_tmp || true
          echo "Cleanup complete."

