name: Process ParkBee HAR to BigQuery

on:
  workflow_dispatch:
    inputs:
      har_filename:
        description: "HAR file name in GCS (e.g., parkbee_2025-01-18.har)"
        required: true
        type: string

jobs:
  har-to-bigquery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Decode GCP service account key
        run: echo "${{ secrets.GCP_SA_KEY_B64 }}" | base64 --decode > $HOME/key.json

      - name: Authenticate with gcloud
        run: |
          gcloud auth activate-service-account --key-file=$HOME/key.json
          gcloud config set project grand-water-473707-r8

      - name: Download HAR file from GCS
        run: gsutil cp gs://parkbee-har-data/${{ github.event.inputs.har_filename }} .

      - name: Run extraction script
        run: python scripts/extract_parkbee.py ${{ github.event.inputs.har_filename }}

      - name: Upload JSON to GCS
        run: |
          JSON_FILE=$(ls parkbee_garages_*.json)
          gsutil cp $JSON_FILE gs://parkbee-raw-data/$JSON_FILE
          echo "Uploaded JSON to parkbee-raw-data bucket: $JSON_FILE"

      - name: Load JSON into BigQuery (temporary table)
        run: |
          JSON_FILE=$(ls parkbee_garages_*.json)
          echo "Loading $JSON_FILE into raw.new_parkbee_garages_tmp..."
          bq load \
            --source_format=NEWLINE_DELIMITED_JSON \
            --autodetect \
            raw.new_parkbee_garages_tmp \
            gs://parkbee-raw-data/$JSON_FILE

      - name: Merge data into raw_parkbee_garages table
        run: |
          echo "Merging data into raw.raw_parkbee_garages..."
          bq query --use_legacy_sql=false "
          MERGE INTO \`raw.raw_parkbee_garages\` AS target
          USING \`raw.new_parkbee_garages_tmp\` AS source
          ON target.id = source.id AND target.scrape_datetime = source.scrape_datetime
          WHEN NOT MATCHED THEN
            INSERT ROW;
          "
          echo "Merge complete!"
